configs:
  traefik-ts-serve:
    content: |
      {"TCP":{"443":{"HTTPS":false}},
      "Web":{"$${TS_CERT_DOMAIN}:443":
          {"Handlers":{"/":
          {"Proxy":"http://127.0.0.1:80"}}}},
      "AllowFunnel":{"$${TS_CERT_DOMAIN}:443":false}}
  traefik-static:
    content: |
      # ============================================
      # Global Settings
      # ============================================
      global:
        checkNewVersion: true
        sendAnonymousUsage: false

      # ============================================
      # Logging
      # ============================================
      log:
        level: INFO
        # level: DEBUG  # Uncomment for troubleshooting

      accessLog:
        format: json

      # ============================================
      # API & Dashboard
      # ============================================
      api:
        dashboard: true
        insecure: false

      # ============================================
      # EntryPoints
      # ============================================
      entryPoints:
        # HTTP EntryPoint
        web:
          address: ":80"
          http:
            redirections:
              entryPoint:
                to: websecure
                scheme: https
                permanent: true

        # HTTPS EntryPoint
        websecure:
          address: ":443"

      # ============================================
      # Certificate Resolvers
      # ============================================
      certificatesResolvers:
        # Tailscale certification
        tailscaleresolver:
          tailscale: true

        # Let's Encrypt (ACME) Configuration
        letsencrypt:
          acme:
            email: eugene@dotnetbistro.cloud
            storage: /letsencrypt/acme.json
            dnsChallenge:
              provider: cloudflare
              resolvers:
                - "1.1.1.1:53"
                - "9.9.9.9:53"
              delayBeforeCheck: 5

      # ============================================
      # Docker Provider
      # ============================================
      providers:
        docker:
          exposedByDefault: false
          network: proxy
          watch: true
        file:
          directory: /etc/traefik/dynamic/
          watch: true

      ping: {}
      # ============================================
      # Metrics (Optional - Prometheus)
      # ============================================
      # metrics:
      #   prometheus:
      #     buckets:
      #       - 0.1
      #       - 0.3
      #       - 1.2
      #       - 5.0

volumes:
  traefik-cert:
  traefik-config:

services:
  traefik-ts:
    environment:
      - TS_SERVE_CONFIG=/config/serve.json
    configs:
      - source: traefik-ts-serve
        target: /config/serve.json

  traefik-app:
    configs:
      - source: traefik-static
        target: /etc/traefik/traefik.yaml
      #   target: /etc/traefik/dynamic/config.yaml
    environment:
      - TRAEFIK_DASHBOARD_USER=${TRAEFIK_DASHBOARD_USER:-admin}
      - TRAEFIK_DASHBOARD_PASSWORD_HASH=${TRAEFIK_DASHBOARD_PASSWORD_HASH}
      - CF_DNS_API_TOKEN=${CF_DNS_API_TOKEN}
    volumes:
      - traefik-cert:/letsencrypt
      - traefik-config:/etc/traefik/dynamic
